<!DOCTYPE html>
<html>
	<head>
		<title>Teste</title>
		<meta charset="utf-8" />
	</head>
	<body>
		<h1>Teste</h1>
		<canvas id="tela" width="640" height="320"></canvas>
		<script>
			var tela = document.getElementById('tela');
			var ctx = tela.getContext('2d');
			var imgPc = new Image();
			imgPc.src = 'pc.svg';
			var imgWall = new Image();
			imgWall.src = 'wall.svg';
			var imgBlock = new Image();
			imgBlock.src = 'block.svg';
			var x = 0;
			var fps = 30;
			var dt = 1.0/fps;
			var g = 300;
			var mapa = [
				[1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1],
				[1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1],
				[1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1],
				[1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1],
				[1,0,1,1,0, 0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1],
				[1,0,0,0,0, 0,0,0,1,1, 0,0,0,0,0, 0,0,0,0,1],
				[1,0,0,1,0, 1,1,0,0,0, 0,0,0,0,0, 0,0,0,0,1],
				[1,0,0,0,0, 0,0,1,1,1, 0,0,0,0,0, 0,0,0,0,1],
				[1,0,0,0,0, 1,1,1,1,1, 0,0,0,0,0, 0,0,0,0,1],
				[1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1]
			];
			var pc = {
				x: 32*3,
				y: 32*2,
				vx: 0,
				vy: 0,
				ax: 0,
				ay: 0,
				mx: 3,
				my: 2,
				desenha: function(ctx){
					if(this.vx>=0){
						ctx.drawImage(imgPc,0,0,32,32,this.x-16,this.y-32,32,32);
					}else{
						ctx.save();
						ctx.translate(this.x,this.y);
						ctx.scale(-1,1);
						ctx.drawImage(imgPc,0,0,32,32,-16,-32,32,32);
						ctx.restore();
					}
					ctx.strokeStyle = "red";
					ctx.beginPath();
					ctx.moveTo(this.x-5,this.y-5);
					ctx.lineTo(this.x+5,this.y+5);
					ctx.lineTo(this.x+5,this.y-5);
					ctx.lineTo(this.x-5,this.y+5);
					ctx.closePath();
					ctx.stroke();
					ctx.strokeRect(this.mx*32, this.my*32,32,32);
				},
				move: function(dt){
					this.vx = this.vx + this.ax*dt;
					this.vy = this.vy + this.ay*dt + g*dt;
					var dx = this.vx*dt;
					var dy = this.vy*dt;
					if(mapa[this.my][this.mx+1] == 1 && this.vx>0){
						dx = Math.round(Math.min((this.mx+1)*32-this.x-8, this.vx*dt));
						if(Math.abs(dx)<0.001) this.vx = 0;
					}
					if(mapa[this.my][this.mx-1] == 1 && this.vx<0){
						dx = Math.round(Math.max((this.mx*32)-this.x+8, this.vx*dt));
						if(Math.abs(dx)<0.001) this.vx = 0;
					}
					if(mapa[this.my-1][this.mx] == 1 && this.vy<0){
						dy = Math.round(Math.max((this.my)*32-this.y+16, this.vy*dt));
					}
					if(mapa[this.my+1][this.mx] == 1 && this.vy>0){
						dy = Math.round(Math.min((this.my+1)*32-this.y-1, this.vy*dt));
					}
					if(Math.abs(dy)<0.001) this.vy = 0;
					this.x = this.x + dx;
					this.y = this.y + dy;
					this.mx = Math.floor(this.x/32);
					this.my = Math.floor(this.y/32);
				}
			}
			setInterval(desenha, 1000*dt);
			function desenha(){
				pc.move(dt);
				//ctx.clearRect(0,0,tela.width,tela.height);
				desenhaMapa();
				ctx.fillText(x++,50,20);
				pc.desenha(ctx);
				ctx.beginPath()
				ctx.strokeStyle = "blue";
				ctx.moveTo(0,pc.my*32);
				ctx.lineTo(tela.height, pc.my*32)
				ctx.closePath();
				ctx.stroke();
				ctx.beginPath()
				ctx.strokeStyle = "yellow";
				ctx.moveTo(0,(pc.my+1)*32);
				ctx.lineTo(tela.width, (pc.my+1)*32)
				ctx.closePath();
				ctx.stroke();
				ctx.beginPath()
				ctx.strokeStyle = "yellow";
				ctx.moveTo(pc.mx*32,0);
				ctx.lineTo(pc.mx*32,tela.height)
				ctx.closePath();
				ctx.stroke();
			}
			function desenhaMapa(){
				var linhas = tela.height/32;
				var colunas = tela.width/32;
				for (var l = 0; l < linhas; l++) {
					for (var c = 0; c < colunas; c++) {
						if(mapa[l][c]==0){
							ctx.drawImage(imgWall,c*32,l*32);
						} else {
							ctx.drawImage(imgBlock,c*32,l*32);
						}
					}
				}
			}
			addEventListener('keydown', function(e){
				switch(e.keyCode){
					case 37:
						pc.vx = -60;
						e.preventDefault();
						break;
					case 38:
						if(pc.vy == 0 && mapa[pc.my+1][pc.mx] == 1){
							pc.vy = pc.vy -190;
						}
						e.preventDefault();
						break;
					case 39:
						pc.vx =  60;
						e.preventDefault();
						break;
				}
			});
			addEventListener('keyup', function(e){
				switch(e.keyCode){
					case 37:
					case 39:
						pc.vx = 0;
						e.preventDefault();
						break;
					case 38:
						pc.ay = 0;
						e.preventDefault();
						break;
				}
			});
		</script>
	</body>
</html>